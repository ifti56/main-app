name: Sync Demo with Main via Copilot

on:
  push:
    branches:
      - main

jobs:
  sync-demo:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    env:
      DEMO_REPO_TOKEN: ${{ secrets.DEMO_REPO_TOKEN }}
      IGNORE_PATHS: "src/pages/**,src/demo-specific/**"

    steps:
      # Step 1: Checkout main-app
      - name: Checkout main-app
        uses: actions/checkout@v4
        with:
          path: main-app

      # Step 2: Checkout demo-app
      - name: Checkout demo-app
        uses: actions/checkout@v4
        with:
          repository: ifti56/demo-app
          token: ${{ secrets.DEMO_REPO_TOKEN }}
          path: demo-app

      # Step 3: Generate surgical diff of changed lines only
      - name: Generate main changes diff
        id: generate-diff
        run: |
          cd main-app
          git fetch origin main
          git diff HEAD origin/main --unified=0 > ../main_changes.diff || true
          cat ../main_changes.diff

      # Step 4: Apply changes to demo-app using git apply
      - name: Apply changes to demo-app
        id: apply-changes
        run: |
          cd demo-app
          # Check if diff file has content
          if [ ! -s ../main_changes.diff ]; then
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "ℹ No changes to apply (branches are identical)"
            exit 0
          fi
          
          echo "changes_made=true" >> $GITHUB_OUTPUT
          
          # Attempt to apply the diff
          if git apply ../main_changes.diff --check; then
            git apply ../main_changes.diff
            echo "✓ Changes applied successfully"
          else
            echo "⚠ Some hunks could not be applied - trying with --3way"
            git apply --3way ../main_changes.diff || {
              echo "✗ Failed to apply diff with --3way"
              exit 1
            }
          fi

      # Step 5: Commit changes to new branch in demo-app
      - name: Commit changes
        if: steps.apply-changes.outputs.changes_made == 'true'
        run: |
          cd demo-app
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b sync/auto-${GITHUB_RUN_ID}
          git add .
          git commit -m "chore(sync): Auto-sync from main-app (${GITHUB_SHA::7})" || echo "No changes to commit"

      # Step 6: Push branch to demo-app
      - name: Push branch
        if: steps.apply-changes.outputs.changes_made == 'true'
        run: |
          cd demo-app
          git push origin HEAD

      # Step 7: Create Pull Request
      - name: Create Pull Request
        if: steps.apply-changes.outputs.changes_made == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          path: demo-app
          token: ${{ secrets.DEMO_REPO_TOKEN }}
          branch: sync/auto-${GITHUB_RUN_ID}
          title: "chore(sync): Automated Demo Sync"
          body: |
            This PR was automatically generated to sync demo-app with main-app.
            Main commit: ${{ github.sha }}
            - Applied changes from main-app
            - Files in ignore list skipped
