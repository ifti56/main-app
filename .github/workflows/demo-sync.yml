name: Sync Demo with Main via Copilot

on:
  push:
    branches:
      - main

jobs:
  sync-demo:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    env:
      DEMO_REPO_TOKEN: ${{ secrets.DEMO_REPO_TOKEN }}
      IGNORE_PATHS: "src/pages/**,src/demo-specific/**"

    steps:
      # Step 1: Checkout main-app
      - name: Checkout main-app
        uses: actions/checkout@v4
        with:
          path: main-app

      # Step 2: Checkout demo-app
      - name: Checkout demo-app
        uses: actions/checkout@v4
        with:
          repository: ifti56/demo-app
          token: ${{ secrets.DEMO_REPO_TOKEN }}
          path: demo-app

      # Step 3: Generate surgical diff of changed lines only
      - name: Generate main changes diff
        id: generate-diff
        run: |
          git --git-dir=main-app/.git fetch origin main
          git --git-dir=main-app/.git diff --unified=0 ${{ github.event.before }} ${{ github.event.after }} > main_changes.diff
          cat main_changes.diff

      # Step 4: Run Copilot to apply changes
      - name: Run Copilot to sync demo
        id: copilot
        uses: github/copilot-actions@v1
        with:
          prompt: |
            You are syncing the demo-app frontend with main-app.
            Only apply changes from main_changes.diff to demo-app.
            Respect intentional differences marked by:
            /* DEMO-INTENTIONAL-START */ ... /* DEMO-INTENTIONAL-END */
            Do not modify files matching ignore list: ${{ env.IGNORE_PATHS }}.
            If a hunk cannot be applied exactly, skip it and note it.
            Provide JSON output: {files: [{path, new_content, note}]}

          files: |
            main-app/**
            demo-app/**
            main_changes.diff

      # Step 5: Apply Copilot output to demo-app
      - name: Apply Copilot changes
        run: |
          mkdir -p temp_changes
          echo "${{ steps.copilot.outputs.result }}" > temp_changes/copilot_output.json

          # Loop over each file in JSON output
          cat temp_changes/copilot_output.json | jq -c '.files[]' | while read file; do
            path=$(echo "$file" | jq -r '.path')
            content=$(echo "$file" | jq -r '.new_content')
            mkdir -p $(dirname demo-app/$path)
            echo "$content" > demo-app/$path
          done

      # Step 6: Commit changes to new branch in demo-app
      - name: Commit changes
        run: |
          cd demo-app
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b sync/copilot-auto-${GITHUB_RUN_ID}
          git add .
          git commit -m "chore(sync): Copilot auto-sync from main-app (${GITHUB_SHA::7})" || echo "No changes to commit"

      # Step 7: Push branch to demo-app
      - name: Push branch
        run: |
          cd demo-app
          git push origin HEAD

      # Step 8: Create PR
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          path: demo-app
          branch: sync/copilot-auto-${GITHUB_RUN_ID}
          title: "Copilot: Automated Demo Sync"
          body: |
            This PR was automatically generated by Copilot to sync demo-app with main-app.
            Main commit: ${{ github.sha }}
            - Files synced from main-app changes
            - Intentional differences preserved
            - Files in ignore list skipped
